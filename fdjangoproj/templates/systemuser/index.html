{% include "partials/header.html" %}

<body class="sb-nav-fixed">
    {% include "partials/navbar.html" %}
    <div id="layoutSidenav">
        {% include "partials/sidebar.html" %}

        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4">Dashboard</h1>
                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item active">Dashboard</li>
                    </ol>

                    <div class="container mt-4">
                        <div class="row g-4 align-items-start">

                            <!-- ðŸŸ¢ Left Column (Inventory + Category Chart Side by Side) -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm mb-4">
                                    <div class="card-body">
                                        <h5 class="text-center mb-4">
                                            <i class="bi bi-box-seam me-2"></i> Inventory Overview
                                        </h5>

                                        <div class="charts-container text-center">
                                            <!-- ðŸŸ© Progress Circle -->
                                            <div class="chart-item">
                                                <p class="text-muted mb-2" style="margin-top: -30px;">Storage Usage</p>
                                                <div class="progress-circle" data-value="{{ storage_used_percentage }}">
                                                    <span class="progress-text">{{ storage_used_percentage }}%</span>
                                                </div>
                                                <p class="text-muted mb-2" style="margin-top: 10px;">{{ total_quantity }} of {{ max_capacity }} items stored</p>
                                            </div>

                                            <!-- ðŸŸ¦ Category Donut Chart -->
                                            <div class="chart-item">
                                                <p class="text-muted mb-2">Storage Distribution by Category</p>
                                                <div class="chart-wrapper">
                                                    <canvas id="categoryChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ”µ Right Column (Cards in 2x2 grid) -->
                            <div class="col-lg-6">
                                <div class="row g-3">

                                    <!-- ðŸŸ¦ Total Categories -->
                                    <div class="col-md-6">
                                        <div class="card bg-primary text-white shadow h-100 py-2">
                                            <div class="card-body d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="text-white-50 small">Total Categories</div>
                                                    <div class="fs-4 fw-bold">{{ category_count }}</div>
                                                </div>  
                                                <i class="fa-solid fa-tags fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ðŸŸ© Total Items -->
                                    <div class="col-md-6">
                                        <div class="card bg-success text-white shadow h-100 py-2">
                                            <div class="card-body d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="text-white-50 small">Total Items</div>
                                                    <div class="fs-4 fw-bold">{{ total_items }}</div>
                                                </div>
                                                <i class="fa-solid fa-box-open fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ðŸŸ¨ Low Stock Items -->
                                    <div class="col-md-6">
                                        <div class="card bg-warning text-white shadow h-100 py-2">
                                            <div class="card-body d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="text-white-50 small">Low Stock</div>
                                                    <div class="fs-4 fw-bold">{{ low_stock_items }}</div>
                                                </div>
                                                <i class="fa-solid fa-triangle-exclamation fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ðŸŸ¥ Out of Stock -->
                                    <div class="col-md-6">
                                        <div class="card bg-danger text-white shadow h-100 py-2">
                                            <div class="card-body d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="text-white-50 small">Out of Stock</div>
                                                    <div class="fs-4 fw-bold">{{ out_of_stock_items }}</div>
                                                </div>
                                                <i class="fa-solid fa-circle-xmark fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        </div>
                    </div>

                    <!-- ðŸ§¾ Sample DataTable -->
                    <div class="card-body mt-4">
                        <table id="datatablesSimple" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>Office</th>
                                    <th>Age</th>
                                    <th>Start date</th>
                                    <th>Salary</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tiger Nixon</td>
                                    <td>System Architect</td>
                                    <td>Edinburgh</td>
                                    <td>61</td>
                                    <td>2011/04/25</td>
                                    <td>$320,800</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    {% include "partials/scripts.html" %}
</body>
</html>

<!-- ðŸŽ¨ Styles -->
<style>
/* ===== Progress Circle ===== */
.progress-circle {
    --size: 240px;
    width: var(--size);
    height: var(--size);
    border-radius: 50%;
    background: conic-gradient(
        var(--bar-color, #198754) calc(var(--percent, 0) * 1%),
        #e9ecef 0
    );
    display: flex;
    align-items: center;
    justify-content: center;
    margin: auto;
    position: relative;
    transition: background 0.1s linear;
}

.progress-circle::before {
    content: "";
    position: absolute;
    width: calc(var(--size) - 75px);
    height: calc(var(--size) - 75px);
    background: #fff;
    border-radius: 50%;
}

.progress-text {
    position: relative;
    font-size: 1.6rem;
    font-weight: 600;
    color: #212529;
}

/* ===== Charts Alignment Fix ===== */
.charts-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0px;
    flex-wrap: wrap;
}

.chart-item {
    text-align: center;
}

.chart-wrapper {    
    width: 310px;
    height: 310px;
    margin: 0 auto;
    position: relative;
}

#categoryChart {
    width: 100% !important;
    height: 100% !important;
}
</style>

<!-- ðŸ“Š Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Category Chart
    const ctx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = {{ category_data|safe }};
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(c => c.name),
            datasets: [{
                data: categoryData.map(c => c.percentage),
                backgroundColor: categoryData.map(c => c.color),
                borderWidth: 2
            }]
        },
        options: {
            cutout: '68%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.formattedValue}%`;
                        }
                    }
                }
            }
        }
    });

    // ðŸŸ¢ Inventory Progress Circle Animation (with ease-out)
    document.querySelectorAll(".progress-circle").forEach(circle => {
        const value = parseFloat(circle.getAttribute("data-value")) || 0;
        const targetPercent = Math.min(Math.max(value, 0), 100);

        // Color logic
        let color = "#198754"; // green
        if (targetPercent > 70 && targetPercent <= 90) color = "#ffc107"; // yellow
        else if (targetPercent > 90) color = "#dc3545"; // red
        circle.style.setProperty("--bar-color", color);

        // Animation setup
        let startTime = null;
        const duration = 1000; // in ms (1.5 seconds)
        const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

        function animateProgress(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1); // normalize to 0â€“1
            const eased = easeOutCubic(progress);
            const current = Math.round(eased * targetPercent);

            circle.style.setProperty("--percent", current);

            if (progress < 1) {
                requestAnimationFrame(animateProgress);
            }
        }

        requestAnimationFrame(animateProgress);
    });

    // Circular Progress Animation
    document.querySelectorAll(".progress-circle").forEach(circle => {
        const value = parseFloat(circle.getAttribute("data-value")) || 0;
        const percent = Math.min(Math.max(value, 0), 100);
        circle.style.setProperty("--percent", percent);

        let color = "#198754"; // green
        if (percent > 70 && percent <= 90) color = "#ffc107"; // yellow
        else if (percent > 90) color = "#dc3545"; // red

        circle.style.setProperty("--bar-color", color);
    });
});
</script>
